<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Servicio / Cita - Panel de Administración</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script>
        // Auth check
        let currentUser = null; let isAuthenticated = false;
        try {
            const storedUserData = localStorage.getItem('userData');
            if (!storedUserData) { console.log("No auth. Redirect login..."); window.location.replace('login.html'); throw new Error("Redirect login"); }
            currentUser = JSON.parse(storedUserData);
            // Asegurarse que el ID del usuario también exista
            if (!currentUser || !currentUser.username || !currentUser.id) {
                 console.error("Auth Check (Head): Invalid user data in storage (missing id or username).");
                 localStorage.removeItem('userData'); // Limpiar datos inválidos
                 window.location.replace('login.html');
                 throw new Error("Invalid user data.");
             }
            console.log("Auth OK:", currentUser.username, "ID:", currentUser.id); isAuthenticated = true;
            document.addEventListener('DOMContentLoaded', () => {
                if (document.body) document.body.classList.remove('auth-pending');
                const userNameDisplay = document.getElementById('user-name-display');
                const userRoleDisplay = document.getElementById('user-role-display');
                const profileNameDisplay = document.getElementById('profile-name-display');
                if (userNameDisplay) userNameDisplay.textContent = currentUser.nombre || currentUser.username;
                if (userRoleDisplay) userRoleDisplay.textContent = currentUser.rol || 'Usuario';
                if (profileNameDisplay) profileNameDisplay.textContent = currentUser.nombre || currentUser.username;
                 console.log("UI Updated.");
            });
        } catch (e) {
             if (e.message !== "Redirect login" && e.message !== "Invalid user data.") {
                 console.error("Auth Error:", e);
                 localStorage.removeItem('userData');
                 window.location.replace('login.html');
             }
         }
    </script>

    <style>
        /* Styles (iguales que antes) */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .active-link { background-color: #e0f2fe; color: #0c4a6e; font-weight: 600; }
        .sidebar-link:hover { background-color: #f0f9ff; color: #0c4a6e; }
        .main-container { min-height: 100vh; display: flex; }
        .main-content-area { flex-grow: 1; display: flex; flex-direction: column; margin-left: 16rem; width: calc(100% - 16rem); }
        .header { height: 4rem; background-color: white; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); display: flex; align-items: center; justify-content: flex-end; padding: 0 1.5rem; flex-shrink: 0; position: sticky; top: 0; z-index: 10; }
        .page-content { padding: 1.5rem; flex-grow: 1; overflow-y: auto; }
        .form-section { background-color: white; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); transition: opacity 0.3s ease-in-out; }
        .form-section fieldset:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-section fieldset:disabled > * { cursor: not-allowed; }
        .form-step-indicator { display: flex; align-items: center; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; }
        .step-circle { width: 2rem; height: 2rem; border-radius: 9999px; background-color: #d1d5db; color: #4b5563; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 0.75rem; flex-shrink: 0; border: 2px solid transparent; transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out, border-color 0.3s ease-in-out; }
        .step-circle-active { background-color: #bfdbfe; color: #1d4ed8; border-color: #2563eb; }
        .step-circle-complete { background-color: #a7f3d0; color: #065f46; border-color: #10b981; }
        .step-title { font-weight: 600; color: #1f2937; font-size: 1.125rem; }
        label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; color: #374151; }
        input[type="text"], input[type="email"], input[type="tel"], input[type="number"], input[type="date"], input[type="time"], select, textarea { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: inset 0 1px 2px 0 rgb(0 0 0 / 0.05); font-size: 0.875rem; transition: border-color 0.2s ease-in-out; }
        input:focus, select:focus, textarea:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: #2563eb; box-shadow: 0 0 0 2px #bfdbfe; }
        input.is-invalid, select.is-invalid, textarea.is-invalid { border-color: #ef4444; }
        input.is-invalid:focus, select.is-invalid:focus, textarea.is-invalid:focus { border-color: #ef4444; box-shadow: 0 0 0 2px #fecaca; }
        .error-message { color: #dc2626; font-size: 0.75rem; margin-top: 0.25rem; display: none; min-height: 1em; }
        input.is-invalid.interacted + .error-message, select.is-invalid.interacted + .error-message, textarea.is-invalid.interacted + .error-message { display: block; }
        input.is-invalid.submit-attempted + .error-message, select.is-invalid.submit-attempted + .error-message, textarea.is-invalid.submit-attempted + .error-message { display: block; }
        input:disabled, select:disabled, textarea:disabled, button:disabled { background-color: #f3f4f6; cursor: not-allowed; opacity: 0.7; }
        select:disabled { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        .input-group { display: flex; align-items: center; }
        .input-group input { border-top-right-radius: 0; border-bottom-right-radius: 0; flex-grow: 1; }
        .input-group-append { padding: 0.5rem 0.75rem; background-color: #f3f4f6; border: 1px solid #d1d5db; border-left: 0; border-top-right-radius: 0.375rem; border-bottom-right-radius: 0.375rem; font-size: 0.875rem; color: #4b5563; }
        .button-group { display: flex; justify-content: flex-end; margin-top: 1.5rem; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 0.375rem; font-weight: 600; text-align: center; cursor: pointer; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, opacity 0.2s ease-in-out; border: 1px solid transparent; font-size: 0.875rem; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background-color: #6b7280; color: white; margin-right: 0.5rem; }
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .btn-secondary:disabled { opacity: 0.5; cursor: not-allowed; }
        .sidebar { width: 16rem; background-color: #ffffff; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; flex-shrink: 0; height: 100vh; position: fixed; top: 0; left: 0; z-index: 20; }
        .sidebar-header { height: 4rem; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #e5e7eb; padding: 0 1rem; flex-shrink: 0; }
        .sidebar-nav { flex-grow: 1; margin-top: 1.5rem; padding: 0 1rem; space-y: 0.5rem; overflow-y: auto; }
        .sidebar-link { display: flex; align-items: center; padding: 0.625rem 1rem; font-size: 0.875rem; border-radius: 0.375rem; color: #374151; text-decoration: none; }
        .sidebar-link i { width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; color: #6b7280; }
        .active-link i { color: #0c4a6e; }
        .sidebar-footer { padding: 1rem; margin-top: auto; border-top: 1px solid #e5e7eb; flex-shrink: 0; }
        .user-info { text-align: center; padding: 1rem 1rem 0; flex-shrink: 0; }
        .user-name { font-weight: 600; color: #1f2937; }
        .user-role { font-size: 0.75rem; color: #6b7280; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; }
        .form-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1rem 1.5rem; }
        @media (min-width: 768px) { .form-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } .col-span-full { grid-column: 1 / -1; } }
        .btn-outline { background-color: transparent; border: 1px solid #2563eb; color: #2563eb; padding: 0.4rem 0.8rem; font-size: 0.75rem; }
        .btn-outline:hover { background-color: #eff6ff; }
        .feedback-message { font-size: 0.875rem; padding: 0.75rem 1rem; border-radius: 0.375rem; margin-top: 1rem; margin-bottom: 1rem; text-align: center; display: none; }
        .feedback-success { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .feedback-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .feedback-loading { background-color: #e0f2fe; color: #075985; border: 1px solid #7dd3fc; }
        body.auth-pending .main-container { visibility: hidden; opacity: 0; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        body:not(.auth-pending) .main-container { visibility: visible; opacity: 1; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="auth-pending">

    <div class="main-container">
        <aside class="sidebar">
             <div class="sidebar-header"> <img src="https://placehold.co/150x40/003366/FFFFFF?text=A%26S+Palermo" alt="Logo A&S Palermo SAC" class="h-8"> </div>
             <div class="user-info px-4 pt-4"> <p id="user-name-display" class="user-name">Cargando...</p> <p id="user-role-display" class="user-role">Cargando...</p> </div>
             <nav class="sidebar-nav">
                 <a href="admin_vehiculos.html" class="sidebar-link"> <i class="fas fa-car"></i> Vehículos </a>
                 <a href="admin_servicios.html" class="sidebar-link"> <i class="fas fa-wrench"></i> Servicios </a>
                 <a href="admin_miscitas.html" class="sidebar-link"> <i class="fas fa-calendar-check"></i> Mis Citas </a>
                 <a href="admin.html" class="sidebar-link active-link"> <i class="fas fa-plus-circle"></i> Nuevo Servicio </a>
             </nav>
             <div class="sidebar-footer"> <p class="text-xs text-gray-400 text-center">Panel de Administración v1.0</p> </div>
        </aside>

        <div class="main-content-area">
             <header class="header">
                 <div class="flex items-center space-x-4"> <button class="flex items-center text-sm text-gray-600 hover:text-gray-800"> <i class="fas fa-user-circle mr-1"></i> <span id="profile-name-display">Ver Perfil</span> <i class="fas fa-chevron-down ml-1 text-xs"></i> </button> <span class="text-gray-300">|</span> <button id="logout-button" class="text-sm text-gray-600 hover:text-red-700"> <i class="fas fa-sign-out-alt mr-1"></i> Cerrar Sesión </button> </div>
             </header>

             <main class="page-content">
                 <h1 class="text-2xl font-semibold text-gray-800 mb-6">NUEVO SERVICIO / CITA</h1>
                 <form id="nuevo-servicio-form" action="#" method="POST" novalidate>
                     <section id="section-1" class="form-section">
                         <div class="form-step-indicator"> <span id="step-circle-1" class="step-circle step-circle-active">1</span> <h2 class="step-title">Datos del Cliente</h2> </div>
                         <fieldset id="fieldset-1">
                             <div class="form-grid">
                                 <div>
                                     <label for="nombres-cliente">Nombres</label>
                                     <input type="text" id="nombres-cliente" name="nombres_cliente" placeholder="Ej: Juan Carlos" required>
                                     <span class="error-message" id="error-nombres-cliente">Este campo es obligatorio.</span>
                                 </div>
                                 <div>
                                     <label for="apellidos-cliente">Apellidos</label>
                                     <input type="text" id="apellidos-cliente" name="apellidos_cliente" placeholder="Ej: Pérez Gómez" required>
                                     <span class="error-message" id="error-apellidos-cliente">Este campo es obligatorio.</span>
                                 </div>
                                 <div>
                                     <label for="email-cliente">Correo Electrónico</label>
                                     <input type="email" id="email-cliente" name="email_cliente" placeholder="ejemplo@correo.com">
                                     <span class="error-message" id="error-email-cliente">Ingrese un correo electrónico válido.</span>
                                 </div>
                                 <div>
                                     <label for="telefono-cliente">Teléfono / Celular</label>
                                     <input type="tel" id="telefono-cliente" name="telefono_cliente" placeholder="Ej: 987654321" required pattern="[0-9]{7,15}">
                                     <span class="error-message" id="error-telefono-cliente">Ingrese un número de teléfono válido (solo números, 7-15 dígitos).</span>
                                 </div>
                             </div>
                         </fieldset>
                     </section>
                     <section id="section-2" class="form-section">
                          <div class="form-step-indicator"> <span id="step-circle-2" class="step-circle">2</span> <h2 class="step-title">Datos del Vehículo</h2> </div>
                          <fieldset id="fieldset-2" disabled>
                              <div class="form-grid">
                                  <div class="col-span-full">
                                      <label for="select-vehiculo-cliente">Seleccionar Vehículo Registrado</label>
                                      <select id="select-vehiculo-cliente" name="vehiculo_registrado_id" required>
                                          <option value="" disabled selected>-- Ingrese teléfono del cliente primero --</option>
                                          </select>
                                      <span class="error-message" id="error-select-vehiculo-cliente">Debe seleccionar un vehículo.</span>
                                      <p class="text-xs text-gray-500 mt-1">Seleccione un vehículo asociado a este cliente o añada uno nuevo.</p>
                                  </div>
                                  <div class="col-span-full text-right">
                                      <button type="button" id="btn-toggle-add-vehicle" class="btn btn-outline">
                                          <i class="fas fa-plus mr-1"></i> Añadir Nuevo Vehículo
                                      </button>
                                  </div>
                              </div>
                              <div id="add-new-vehicle-section" class="mt-4 pt-4 border-t border-gray-200 hidden">
                                  <p class="text-sm font-medium text-gray-700 mb-3">Datos del Nuevo Vehículo:</p>
                                  <div class="form-grid">
                                      <div> <label for="marca-vehiculo">Marca</label> <input type="text" id="marca-vehiculo" name="marca_vehiculo" placeholder="Ej: Toyota" required> <span class="error-message" id="error-marca-vehiculo">La marca es obligatoria.</span> </div>
                                      <div> <label for="modelo-vehiculo">Modelo</label> <input type="text" id="modelo-vehiculo" name="modelo_vehiculo" placeholder="Ej: Yaris" required> <span class="error-message" id="error-modelo-vehiculo">El modelo es obligatorio.</span> </div>
                                      <div> <label for="ano-vehiculo">Año</label> <input type="number" id="ano-vehiculo" name="ano_vehiculo" placeholder="Ej: 2018" min="1980" max="2025" required> <span class="error-message" id="error-ano-vehiculo">Ingrese un año válido (4 dígitos).</span> </div>
                                      <div> <label for="placa-vehiculo">Placa</label> <input type="text" id="placa-vehiculo" name="placa_vehiculo" placeholder="Ej: ABC-123" required> <span class="error-message" id="error-placa-vehiculo">La placa es obligatoria.</span> </div>
                                      <div id="save-vehicle-feedback" class="col-span-full"></div>
                                  </div>
                                  <input type="hidden" id="is_new_vehicle" name="is_new_vehicle" value="0">
                              </div>
                           </fieldset>
                     </section>
                     <section id="section-3" class="form-section">
                         <div class="form-step-indicator"> <span id="step-circle-3" class="step-circle">3</span> <h2 class="step-title">Detalles del Servicio y Cita</h2> </div>
                         <fieldset id="fieldset-3" disabled>
                             <div class="form-grid">
                                 <div>
                                     <label for="kilometraje">Kilometraje</label>
                                     <div class="input-group"> <input type="number" id="kilometraje" name="kilometraje" placeholder="Ej: 15500" min="0"> <span class="input-group-append">Km</span> </div>
                                     <span class="error-message" id="error-kilometraje">Ingrese un kilometraje válido (número positivo).</span>
                                 </div>
                                 <div>
                                     <label for="select-servicio">Servicio Principal</label>
                                     <select id="select-servicio" name="servicio_id" required>
                                         <option value="" disabled selected>-- Seleccionar un servicio --</option>
                                         </select>
                                     <span class="error-message" id="error-select-servicio">Debe seleccionar un servicio.</span>
                                 </div>
                                 <div class="col-span-full"> <label for="detalle-sintomas">Motivo / Síntomas / Servicios Adicionales</label> <textarea id="detalle-sintomas" name="detalle_sintomas" rows="4" placeholder="Describe el problema..."></textarea> </div>
                                 <div> <label for="fecha-cita">Fecha de la Cita</label> <input type="date" id="fecha-cita" name="fecha_cita" required> <span class="error-message" id="error-fecha-cita">Seleccione una fecha válida (no pasada).</span> </div>
                                 <div> <label for="hora-cita">Hora de la Cita</label> <input type="time" id="hora-cita" name="hora_cita" required> <span class="error-message" id="error-hora-cita">Seleccione una hora válida.</span> </div>
                             </div>
                         </fieldset>
                     </section>
                     <div id="api-feedback-message" class="mt-4"></div>
                     <div class="button-group">
                         <button type="submit" id="submit-button" class="btn btn-primary" disabled>
                             <i class="fas fa-calendar-check mr-2"></i> Guardar Cita Completa
                         </button>
                     </div>
                 </form>
             </main>
        </div>
    </div>

    <script>
        // La variable 'currentUser' se define y verifica en el script del <head>

        if(currentUser && currentUser.id) { // Asegurarse que currentUser y su ID existen
            // --- DOM Elements ---
            const form = document.getElementById('nuevo-servicio-form');
            const fieldset1 = document.getElementById('fieldset-1');
            const fieldset2 = document.getElementById('fieldset-2');
            const fieldset3 = document.getElementById('fieldset-3');
            const stepCircle1 = document.getElementById('step-circle-1');
            const stepCircle2 = document.getElementById('step-circle-2');
            const stepCircle3 = document.getElementById('step-circle-3');
            const submitButton = document.getElementById('submit-button');
            const selectVehiculo = document.getElementById('select-vehiculo-cliente');
            const btnToggleAddVehicle = document.getElementById('btn-toggle-add-vehicle');
            const addNewVehicleSection = document.getElementById('add-new-vehicle-section');
            const isNewVehicleInput = document.getElementById('is_new_vehicle');
            const saveVehicleFeedback = document.getElementById('save-vehicle-feedback');
            const apiFeedbackMessageDiv = document.getElementById('api-feedback-message');
            const emailInput = document.getElementById('email-cliente');
            const phoneInput = document.getElementById('telefono-cliente');
            const dateInput = document.getElementById('fecha-cita');
            const timeInput = document.getElementById('hora-cita');
            const newVehicleInputs = addNewVehicleSection.querySelectorAll('input[required]');
            const logoutButton = document.getElementById('logout-button');
            const pageTitle = document.querySelector('.page-content h1'); // Referencia al título H1 (aunque no se usa para editar aquí)
            const selectServicio = document.getElementById('select-servicio'); // Referencia al select de servicios

            // --- Variables Globales ---
            let isAddingNewVehicle = false;
            const todayString = new Date().toISOString().split('T')[0];
            let clienteVehiculosCache = {};
            let serviciosDisponibles = []; // Almacena los servicios cargados

            // --- Funciones de Validación ---
            function isValidEmail(email) { if (!email) return true; const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; return emailRegex.test(email); }
            function isValidPhone(phone) { if (!phone) return false; const phoneRegex = /^[0-9]{7,15}$/; return phoneRegex.test(phone); }
            function isValidDate(dateStr) { if (!dateStr) return false; return dateStr >= todayString; } // Solo fechas futuras o hoy para crear
            function isValidTime(timeStr) { if (!timeStr) return false; return true; }
            function isNotEmpty(value) { return value && value.trim() !== ''; }
            function validateField(input, showErrors = false) {
                const errorSpan = document.getElementById(`error-${input.id}`);
                let isValid = true; let errorMessage = '';
                const esCampoNuevoVehiculo = addNewVehicleSection.contains(input);
                if (input.required && !isNotEmpty(input.value) && !(esCampoNuevoVehiculo && !isAddingNewVehicle)) {
                     isValid = false; errorMessage = 'Este campo es obligatorio.';
                }
                else if (input.value) {
                    let validationFn = null;
                    if (input.id === 'email-cliente') validationFn = isValidEmail;
                    else if (input.id === 'telefono-cliente') validationFn = isValidPhone;
                    else if (input.id === 'fecha-cita') validationFn = isValidDate;
                    else if (input.id === 'hora-cita') validationFn = isValidTime;
                    else if (input.id === 'ano-vehiculo') validationFn = (v) => /^\d{4}$/.test(v) && v >= 1980 && v <= new Date().getFullYear() + 1;
                    else if (input.id === 'kilometraje') validationFn = (v) => !isNaN(v) && Number(v) >= 0;
                    else if (input.id === 'select-vehiculo-cliente' && !isAddingNewVehicle) validationFn = isNotEmpty;
                    else if (input.id === 'select-servicio') validationFn = isNotEmpty;
                    if (validationFn) isValid = validationFn(input.value);
                }
                 if (showErrors) { input.classList.toggle('is-invalid', !isValid); input.classList.add('interacted'); if (errorSpan) { errorSpan.textContent = errorMessage; errorSpan.style.display = isValid ? 'none' : 'block'; } }
                 else { if (isValid && input.classList.contains('is-invalid')) { input.classList.remove('is-invalid'); if (errorSpan) errorSpan.style.display = 'none'; } }
                 return isValid;
            }
            function checkSectionValidity(fieldset, showErrors = false) { const inputs = fieldset.querySelectorAll('input:not([type="hidden"]), select, textarea'); return Array.from(inputs).every(input => validateField(input, showErrors)); }
            function checkNewVehicleSectionValidity(showErrors = false) { return Array.from(newVehicleInputs).every(input => validateField(input, showErrors)); }


            // --- Update Form State ---
            function updateFormState(triggerSectionValidation = false) {
                const isS1Valid = checkSectionValidity(fieldset1, triggerSectionValidation);
                let isS2CompleteForS3 = false;

                stepCircle1.classList.toggle('step-circle-complete', isS1Valid);
                stepCircle1.classList.toggle('step-circle-active', !isS1Valid);

                if (isS1Valid) {
                    if (fieldset2.disabled) {
                        fieldset2.disabled = false;
                        cargarVehiculosCliente(); // Cargar vehículos cuando S1 es válido
                    }
                    stepCircle2.classList.add('step-circle-active');
                    stepCircle2.classList.remove('step-circle-complete');

                    if (isAddingNewVehicle) {
                        isS2CompleteForS3 = checkNewVehicleSectionValidity(triggerSectionValidation);
                    } else {
                        isS2CompleteForS3 = validateField(selectVehiculo, triggerSectionValidation);
                    }
                    stepCircle2.classList.toggle('step-circle-complete', isS2CompleteForS3);
                    stepCircle2.classList.toggle('step-circle-active', isS1Valid && !isS2CompleteForS3);

                } else {
                    fieldset2.disabled = true;
                    stepCircle2.classList.remove('step-circle-active', 'step-circle-complete');
                    selectVehiculo.innerHTML = '<option value="" disabled selected>-- Ingrese teléfono del cliente primero --</option>';
                    clienteVehiculosCache = {};
                }

                const canEnableS3 = isS1Valid && isS2CompleteForS3;

                if (canEnableS3) {
                    if (fieldset3.disabled) {
                        fieldset3.disabled = false;
                         // Cargar servicios si aún no se han cargado
                         if (serviciosDisponibles.length === 0) {
                            cargarServiciosSelect();
                         }
                    }
                    stepCircle3.classList.add('step-circle-active');
                    stepCircle3.classList.remove('step-circle-complete');
                    const isS3Valid = checkSectionValidity(fieldset3, triggerSectionValidation);
                    stepCircle3.classList.toggle('step-circle-complete', isS3Valid);
                    stepCircle3.classList.toggle('step-circle-active', !isS3Valid);
                    submitButton.disabled = !isS3Valid;
                } else {
                    fieldset3.disabled = true;
                    stepCircle3.classList.remove('step-circle-active', 'step-circle-complete');
                    submitButton.disabled = true;
                }
            }


            // --- Load Client Vehicles ---
            async function cargarVehiculosCliente() {
                const telefono = phoneInput.value.trim();
                if (!telefono || !isValidPhone(telefono)) {
                    selectVehiculo.innerHTML = '<option value="" disabled selected>-- Teléfono de cliente inválido --</option>';
                    return;
                }
                if (clienteVehiculosCache[telefono]) {
                    console.log("Usando caché de vehículos para:", telefono);
                    populateVehicleSelect(clienteVehiculosCache[telefono]);
                    updateFormState(); // Actualizar estado después de poblar desde caché
                    return;
                }
                console.log(`Fetching vehicles for phone: ${telefono}`);
                selectVehiculo.disabled = true;
                selectVehiculo.innerHTML = '<option value="" disabled selected>-- Cargando vehículos... --</option>';
                try {
                    const response = await fetch(`http://localhost:3000/api/vehiculos/cliente?telefono=${encodeURIComponent(telefono)}`);
                    const result = await response.json();
                    if (response.ok && result.success) {
                        clienteVehiculosCache[telefono] = result.vehicles;
                        populateVehicleSelect(result.vehicles);
                    } else {
                        console.warn("No se encontraron vehículos o hubo un error:", result.message);
                        selectVehiculo.innerHTML = `<option value="" disabled selected>-- ${result.message || 'No se encontraron vehículos'} --</option>`;
                        clienteVehiculosCache[telefono] = []; // Guardar array vacío en caché
                    }
                } catch (error) {
                    console.error("Error fetching vehicles:", error);
                    selectVehiculo.innerHTML = '<option value="" disabled selected>-- Error al cargar vehículos --</option>';
                    showFeedback('Error al cargar vehículos del cliente.', 'error', saveVehicleFeedback);
                     clienteVehiculosCache[telefono] = []; // Guardar array vacío en caché
                } finally {
                    selectVehiculo.disabled = false;
                    updateFormState(true); // Validar y actualizar estado después de cargar
                }
            }

            // --- Populate Vehicle Select ---
            function populateVehicleSelect(vehicles) {
                 selectVehiculo.innerHTML = '';
                 const defaultOption = document.createElement('option');
                 defaultOption.value = "";
                 defaultOption.textContent = "-- Seleccione un vehículo --";
                 defaultOption.disabled = true;
                 defaultOption.selected = true;
                 selectVehiculo.appendChild(defaultOption);

                 if (vehicles && vehicles.length > 0) {
                     vehicles.forEach(v => {
                         const option = document.createElement('option');
                         option.value = v.id_vehiculo;
                         option.textContent = `${v.marca} ${v.modelo} (${v.placa || 'S/P'})`;
                         selectVehiculo.appendChild(option);
                     });
                 }
             }

            // --- Load Services Select Options ---
            async function cargarServiciosSelect() {
                if (!selectServicio) return;
                // Solo cargar si está vacío para evitar recargas innecesarias
                if (selectServicio.options.length <= 1) {
                    selectServicio.innerHTML = '<option value="" disabled selected>-- Cargando servicios... --</option>';
                    try {
                        const response = await fetch('http://localhost:3000/api/servicios');
                        const data = await response.json();
                        if (response.ok && data.success && data.servicios) {
                            serviciosDisponibles = data.servicios;
                            selectServicio.innerHTML = ''; // Limpiar antes de añadir
                            const defaultOption = document.createElement('option');
                            defaultOption.value = "";
                            defaultOption.textContent = "-- Seleccionar un servicio --";
                            defaultOption.disabled = true;
                            defaultOption.selected = true;
                            selectServicio.appendChild(defaultOption);

                            data.servicios.forEach(servicio => {
                                const option = document.createElement('option');
                                option.value = servicio.id_servicio;
                                option.textContent = servicio.nombre_servicio;
                                selectServicio.appendChild(option);
                            });
                            // Añadir opción "Otros"
                            const otrosOption = document.createElement('option');
                            otrosOption.value = "otros";
                            otrosOption.textContent = "Otros servicios / Diagnóstico";
                            selectServicio.appendChild(otrosOption);

                        } else {
                            console.error("Error al cargar servicios:", data.message);
                            selectServicio.innerHTML = '<option value="" disabled selected>-- Error al cargar --</option>';
                        }
                    } catch (error) {
                        console.error("Error de red al cargar servicios:", error);
                        selectServicio.innerHTML = '<option value="" disabled selected>-- Error de red --</option>';
                    }
                }
            }


            // --- Toggle Add New Vehicle Form ---
            function toggleNewVehicleForm() {
                isAddingNewVehicle = !addNewVehicleSection.classList.toggle('hidden');
                isNewVehicleInput.value = isAddingNewVehicle ? '1' : '0';
                saveVehicleFeedback.innerHTML = '';
                apiFeedbackMessageDiv.innerHTML = '';

                // Limpiar errores de validación de la sección que se oculta/muestra
                const sectionToClear = isAddingNewVehicle ? selectVehiculo.closest('.col-span-full') : addNewVehicleSection;
                sectionToClear.querySelectorAll('.is-invalid').forEach(el => { el.classList.remove('is-invalid', 'interacted', 'submit-attempted'); const errorSpan = document.getElementById(`error-${el.id}`); if(errorSpan) errorSpan.style.display = 'none'; });
                document.getElementById('error-select-vehiculo-cliente').style.display = 'none'; // Limpiar error del select específicamente

                if (isAddingNewVehicle) {
                    selectVehiculo.value = "";
                    selectVehiculo.required = false;
                    newVehicleInputs.forEach(input => input.required = true);
                    btnToggleAddVehicle.innerHTML = '<i class="fas fa-times mr-1"></i> Cancelar Añadir';
                } else {
                    selectVehiculo.required = true;
                    newVehicleInputs.forEach(input => { input.required = false; input.value = ''; }); // Limpiar campos de nuevo vehículo
                    btnToggleAddVehicle.innerHTML = '<i class="fas fa-plus mr-1"></i> Añadir Nuevo Vehículo';
                    // Repoblar vehículos si existen en caché
                    const telefono = phoneInput.value.trim();
                    if (clienteVehiculosCache[telefono]) {
                         populateVehicleSelect(clienteVehiculosCache[telefono]);
                    } else {
                         selectVehiculo.innerHTML = '<option value="" disabled selected>-- Ingrese teléfono del cliente primero --</option>';
                    }
                }
                updateFormState(true); // Validar y actualizar estado
            }

             // --- Show Feedback ---
            function showFeedback(message, type = 'info', element) {
                let bgColor, textColor, borderColor, iconClass;
                switch (type) {
                    case 'success': bgColor = 'feedback-success'; iconClass = 'fas fa-check-circle'; break;
                    case 'error': bgColor = 'feedback-error'; iconClass = 'fas fa-exclamation-triangle'; break;
                    case 'loading': bgColor = 'feedback-loading'; iconClass = 'fas fa-spinner fa-spin'; break;
                    default: bgColor = 'bg-gray-100 text-gray-800 border-gray-300'; iconClass = 'fas fa-info-circle'; break; // Clases Tailwind directas
                }
                 // Asegurar que el elemento exista
                 if (!element) {
                     console.warn("Elemento de feedback no encontrado para:", message);
                     return;
                 }
                element.innerHTML = `<div class="feedback-message ${bgColor} flex items-center justify-center border"><i class="${iconClass} mr-2"></i> ${message}</div>`;
                element.style.display = 'block';
                if (type !== 'loading') {
                     setTimeout(() => { if(element) element.style.display = 'none'; }, 5000);
                }
            }

            // --- Event Listeners ---
            form.addEventListener('blur', (event) => {
                const target = event.target;
                if (target.tagName === 'INPUT' || target.tagName === 'SELECT' || target.tagName === 'TEXTAREA') {
                    target.classList.add('interacted');
                    validateField(target, true);
                    updateFormState();
                }
            }, true);

            form.addEventListener('input', () => updateFormState(false));
            form.addEventListener('change', () => updateFormState(false));
            btnToggleAddVehicle.addEventListener('click', toggleNewVehicleForm);

            phoneInput.addEventListener('blur', () => {
                // Cargar vehículos solo si el teléfono es válido
                if(isValidPhone(phoneInput.value)) {
                    cargarVehiculosCliente(); // Esta función ya actualiza el estado al finalizar
                } else {
                    // Limpiar si el teléfono se vuelve inválido
                    selectVehiculo.innerHTML = '<option value="" disabled selected>-- Teléfono de cliente inválido --</option>';
                    clienteVehiculosCache = {};
                    updateFormState();
                }
            });


            // --- Submit Handler (Envia userId) ---
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                apiFeedbackMessageDiv.innerHTML = '';

                // Revalidar todo
                const isS1Valid = checkSectionValidity(fieldset1, true);
                let isS2Valid = false;
                if (isAddingNewVehicle) { isS2Valid = checkNewVehicleSectionValidity(true); }
                else { isS2Valid = checkSectionValidity(fieldset2, true); }
                const isS3Valid = checkSectionValidity(fieldset3, true);
                form.querySelectorAll('input, select, textarea').forEach(el => el.classList.add('submit-attempted'));

                if (isS1Valid && isS2Valid && isS3Valid) {
                    submitButton.disabled = true;
                    showFeedback('Guardando cita...', 'loading', apiFeedbackMessageDiv);

                    // Recopilar datos del formulario
                    const formData = {
                        nombres_cliente: document.getElementById('nombres-cliente').value,
                        apellidos_cliente: document.getElementById('apellidos-cliente').value,
                        email_cliente: document.getElementById('email-cliente').value,
                        telefono_cliente: document.getElementById('telefono-cliente').value,
                        is_new_vehicle: isAddingNewVehicle ? '1' : '0',
                        vehiculo_registrado_id: isAddingNewVehicle ? null : selectVehiculo.value,
                        marca_vehiculo: isAddingNewVehicle ? document.getElementById('marca-vehiculo').value : null,
                        modelo_vehiculo: isAddingNewVehicle ? document.getElementById('modelo-vehiculo').value : null,
                        ano_vehiculo: isAddingNewVehicle ? document.getElementById('ano-vehiculo').value : null,
                        placa_vehiculo: isAddingNewVehicle ? document.getElementById('placa-vehiculo').value : null,
                        kilometraje: document.getElementById('kilometraje').value || null,
                        servicio_id: document.getElementById('select-servicio').value,
                        detalle_sintomas: document.getElementById('detalle-sintomas').value,
                        fecha_cita: dateInput.value,
                        hora_cita: timeInput.value,
                        userId: currentUser.id // <<--- AÑADIDO: Enviar ID del usuario actual
                    };

                    const apiUrl = 'http://localhost:3000/api/citas';
                    const apiMethod = 'POST';

                    console.log(`Enviando datos (${apiMethod}) a ${apiUrl}:`, formData);

                    try {
                        const response = await fetch(apiUrl, {
                            method: apiMethod,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                        const result = await response.json();

                        if (response.ok && result.success) {
                            showFeedback(result.message || 'Cita guardada exitosamente.', 'success', apiFeedbackMessageDiv);
                            form.reset(); // Limpiar formulario
                            // Limpiar validaciones visuales
                            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid', 'interacted', 'submit-attempted'));
                            form.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
                            // Si se estaba añadiendo vehículo, ocultar esa sección
                            if (isAddingNewVehicle) toggleNewVehicleForm();
                            // Limpiar caché de vehículos para este cliente (forzar recarga la próxima vez)
                            const telefono = phoneInput.value.trim(); // Obtener el teléfono antes del reset
                            if (telefono) delete clienteVehiculosCache[telefono];
                            // Resetear estado inicial del formulario (secciones deshabilitadas, etc.)
                            updateFormState();

                        } else {
                            showFeedback(result.message || 'Error al guardar la cita. Verifique los datos.', 'error', apiFeedbackMessageDiv);
                        }
                    } catch (error) {
                        console.error("Error de red al enviar el formulario:", error);
                        showFeedback('Error de conexión con el servidor. Intente nuevamente.', 'error', apiFeedbackMessageDiv);
                    } finally {
                        submitButton.disabled = false; // Habilitar botón de nuevo
                    }

                } else {
                    console.log("Formulario inválido.");
                    showFeedback('Formulario inválido. Por favor corrija los errores marcados.', 'error', apiFeedbackMessageDiv);
                    form.querySelector('.is-invalid')?.focus();
                }
            });

            // --- Logout Functionality ---
            if(logoutButton) { logoutButton.addEventListener('click', () => { localStorage.removeItem('userData'); window.location.replace('login.html'); }); }

            // --- Inicialización ---
            async function inicializarPagina() {
                // Cargar servicios en el dropdown al iniciar
                await cargarServiciosSelect();
                // Configuración inicial para crear cita
                if(dateInput) dateInput.setAttribute('min', todayString);
                if(selectVehiculo) selectVehiculo.required = !isAddingNewVehicle;
                updateFormState(); // Actualizar estado inicial
                console.log("Panel de administración (Nuevo Servicio) cargado y lógica inicializada.");
            }

            inicializarPagina(); // Llamar a la función de inicialización

        } // Cierre del if(currentUser && currentUser.id)
    </script>
</body>
</html>
